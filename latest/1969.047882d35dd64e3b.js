(self.webpackChunkseed_tester=self.webpackChunkseed_tester||[]).push([[1969],{1969:(fe,T,g)=>{g.r(T),g.d(T,{AbstractDynamicComponent:()=>M,AbstractDynamicLoaderComponent:()=>R,AbstractPluginHandler:()=>ue,AbstractReferenceComponent:()=>ae,BaseDynamicEvent:()=>G,BaseDynamicEventSource:()=>U,BeautifierPipe:()=>k,COMMAND_PROVIDER:()=>O,ComponentLoaderService:()=>S,DONT_CODE_CORE:()=>F,DONT_CODE_DOC_API_URL:()=>le,DONT_CODE_STORE_API_URL:()=>se,DynamicEventType:()=>E,DynamicInsertPoint:()=>j,EntityListManager:()=>B,EntityStoreService:()=>ce,PluginBaseComponent:()=>L,PluginCommonModule:()=>de,PluginHandlerHelper:()=>D,PossibleTemplateList:()=>N,SubFieldInfo:()=>P,TemplateList:()=>H,ValueService:()=>pe});var s=g(549),C=g(7022),y=g(2256);new Error("timeout while waiting for mutex to become available"),new Error("mutex already locked");const q=new Error("request for lock canceled");class J{constructor(r,e=q){this._value=r,this._cancelError=e,this._weightedQueues=[],this._weightedWaiters=[]}acquire(r=1){if(r<=0)throw new Error(`invalid weight ${r}: must be positive`);return new Promise((e,t)=>{this._weightedQueues[r-1]||(this._weightedQueues[r-1]=[]),this._weightedQueues[r-1].push({resolve:e,reject:t}),this._dispatch()})}runExclusive(r,e=1){return function(o,r,e,t){return new(e||(e=Promise))(function(i,l){function a(d){try{p(t.next(d))}catch(h){l(h)}}function u(d){try{p(t.throw(d))}catch(h){l(h)}}function p(d){d.done?i(d.value):function n(i){return i instanceof e?i:new e(function(l){l(i)})}(d.value).then(a,u)}p((t=t.apply(o,r||[])).next())})}(this,void 0,void 0,function*(){const[t,n]=yield this.acquire(e);try{return yield r(t)}finally{n()}})}waitForUnlock(r=1){if(r<=0)throw new Error(`invalid weight ${r}: must be positive`);return new Promise(e=>{this._weightedWaiters[r-1]||(this._weightedWaiters[r-1]=[]),this._weightedWaiters[r-1].push(e),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(r){this._value=r,this._dispatch()}release(r=1){if(r<=0)throw new Error(`invalid weight ${r}: must be positive`);this._value+=r,this._dispatch()}cancel(){this._weightedQueues.forEach(r=>r.forEach(e=>e.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var r;for(let e=this._value;e>0;e--){const t=null===(r=this._weightedQueues[e-1])||void 0===r?void 0:r.shift();if(!t)continue;const n=this._value,i=e;this._value-=e,e=this._value+1,t.resolve([n,this._newReleaser(i)])}this._drainUnlockWaiters()}_newReleaser(r){let e=!1;return()=>{e||(e=!0,this.release(r))}}_drainUnlockWaiters(){for(let r=this._value;r>0;r--)this._weightedWaiters[r-1]&&(this._weightedWaiters[r-1].forEach(e=>e()),this._weightedWaiters[r-1]=[])}}class V{constructor(r){this._semaphore=new J(1,r)}acquire(){return o=this,r=void 0,t=function*(){const[,r]=yield this._semaphore.acquire();return r},new((e=void 0)||(e=Promise))(function(i,l){function a(d){try{p(t.next(d))}catch(h){l(h)}}function u(d){try{p(t.throw(d))}catch(h){l(h)}}function p(d){d.done?i(d.value):function n(i){return i instanceof e?i:new e(function(l){l(i)})}(d.value).then(a,u)}p((t=t.apply(o,r||[])).next())});var o,r,e,t}runExclusive(r){return this._semaphore.runExclusive(()=>r())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}var c=g(7138),_=g(2369),I=g(6674),x=g(7863),Y=g(3134);const X=["inlineView"],Z=["fullEditView"];function ee(o,r){if(1&o&&s.\u0275\u0275text(0),2&o){const e=s.\u0275\u0275nextContext();s.\u0275\u0275textInterpolate(e.value)}}function te(o,r){if(1&o&&(s.\u0275\u0275elementStart(0,"div"),s.\u0275\u0275text(1),s.\u0275\u0275elementEnd()),2&o){const e=s.\u0275\u0275nextContext(4);s.\u0275\u0275advance(1),s.\u0275\u0275textInterpolate1(" ",e.value," ")}}function ne(o,r){if(1&o&&s.\u0275\u0275template(0,te,2,1,"div",7),2&o){const e=s.\u0275\u0275nextContext(3);s.\u0275\u0275property("ngIf",e.value)}}function re(o,r){1&o&&s.\u0275\u0275text(0),2&o&&s.\u0275\u0275textInterpolate1(" ",r.$implicit," ")}function ie(o,r){if(1&o){const e=s.\u0275\u0275getCurrentView();s.\u0275\u0275elementContainerStart(0,3),s.\u0275\u0275elementStart(1,"p-dropdown",4),s.\u0275\u0275listener("onChange",function(n){s.\u0275\u0275restoreView(e);const i=s.\u0275\u0275nextContext(2);return s.\u0275\u0275resetView(i.valueChanged(n))}),s.\u0275\u0275template(2,ne,1,1,"ng-template",5),s.\u0275\u0275template(3,re,1,1,"ng-template",6),s.\u0275\u0275elementEnd(),s.\u0275\u0275elementContainerEnd()}if(2&o){const e=s.\u0275\u0275nextContext(2);s.\u0275\u0275property("formGroup",e.form),s.\u0275\u0275advance(1),s.\u0275\u0275property("options",e.options)("formControlName",e.name)("filter",!0)("showClear",!0)("lazy",!0)}}function oe(o,r){if(1&o&&s.\u0275\u0275template(0,ie,4,6,"ng-container",2),2&o){const e=s.\u0275\u0275nextContext();s.\u0275\u0275property("ngIf",e.form)}}let M=(()=>{class o{constructor(){this.parentPosition=null,this.subscriptions=new y.Subscription}setName(e){this.name=e}getValue(){return null!=this.form&&this.updateValueFromForm(),this.value}setValue(e){this.value=e,null!=this.form&&this.hydrateValueToForm()}setParentPosition(e){this.parentPosition=e}setForm(e){this.form=e,null!=this.form&&null!=this.name&&this.createAndRegisterFormControls()}getForm(){return this.form}createAndRegisterFormControls(){const e=new C.FormControl(null,{updateOn:"blur"});this.form.registerControl(this.name,e)}transformToFormGroupValue(e){return e}transformFromFormGroupValue(e){return e}hydrateValueToForm(){if(null!=this.name){const e=this.form.get(this.name);if(null==e)throw new Error("No form control for the name "+this.name);{const t=this.transformToFormGroupValue(this.value);e.setValue(t,{emitEvent:!1})}}}updateValueFromForm(){if(null==this.name)return!1;const e=this.form.get(this.name);if(null==e)throw new Error("No form control for the name "+this.name);return!!e.dirty&&(this.value=this.transformFromFormGroupValue(e.value),e.markAsPristine({onlySelf:!0}),!0)}static toBeautifyString(e,t){if(null==e)return null;let n="";switch(Array.isArray(e)&&(e=e[0]),typeof e){case"string":n=e;break;case"object":n=e instanceof Date?e.toLocaleDateString():JSON.stringify(e,null,2);break;case"undefined":break;default:n=e.toLocaleString()}return null!=t&&n.length>t&&(n=n.substring(0,t-3)+"..."),n}listEventSources(){return[]}selectEventSourceFor(e,t){const n=this.listEventSources();for(const i of n)if(i.type===e){if(null==t)return i;if(i.name==t)return i}return null}ngOnDestroy(){this.subscriptions.unsubscribe()}}return o.\u0275fac=function(e){return new(e||o)},o.\u0275cmp=s.\u0275\u0275defineComponent({type:o,selectors:[["ng-component"]],decls:0,vars:0,template:function(e,t){},encapsulation:2}),o})(),O=new s.InjectionToken("Inject the current command provider interface");const F=new s.InjectionToken("Dont-code core object"),se=new s.InjectionToken("DontCodeStoreApiUrl"),le=new s.InjectionToken("DontCodeStoreDocUrl");let S=(()=>{class o{constructor(e,t,n,i){this.injector=e,this.dontCodeCore=t,this.previewMgr=n,this.provider=i,this.moduleMap=new Map,this.mutex=new V}getOrCreatePluginModuleRef(e){return this.mutex.acquire().then(t=>{try{let n=this.moduleMap.get(e);return n||(n=(0,s.createNgModule)((0,s.getNgModuleById)("dontcode-plugin/"+e),this.injector),n&&this.moduleMap.set(e,n)),n}finally{t()}})}loadPluginModule(e){return this.getOrCreatePluginModuleRef(e.class.source).then(t=>(null!=t&&this.dontCodeCore.initPlugins(),t))}insertComponentForFieldType(e,t){return this.insertComponent("creation/entities/fields/type",t,e)}insertComponent(e,t,n){let l,i=e.positionInSchema;i?(l=!0,n||(n=this.provider?.getJsonAt(e.position))):(l=!1,i=e);const a=this.previewMgr.retrieveHandlerConfig(i,n);return a?(console.debug("Importing from ",a.class.source),this.loadPluginModule(a).then(u=>{const p=u.instance.exposedPreviewHandlers().get(a.class.name);return this.createComponent(p,t,u,l?e:null)}).catch(u=>(console.error("Cannot load module because of ",u),Promise.reject("Cannot load module for source "+a.class.source+" because of "+u)))):Promise.resolve(null)}createComponent(e,t,n,i){const u=t.createComponent(e,{injector:this.injector,ngModuleRef:n}).instance;if(u.initCommandFlow){if(!i)throw new Error("Component "+u.constructor.name+" is a PreviewHandler and parent position is missing.");if(!this.provider)throw new Error("Component "+u.constructor.name+" is a PreviewHandler and CommandProviderInterface is missing.");u.initCommandFlow(this.provider,i)}return u}registerModuleForTest(e,t){this.moduleMap.set(t,null==e.instance?(0,s.createNgModule)(e,this.injector):e)}}return o.\u0275fac=function(e){return new(e||o)(s.\u0275\u0275inject(s.Injector),s.\u0275\u0275inject(F),s.\u0275\u0275inject(c.DontCodePreviewManager),s.\u0275\u0275inject(O,8))},o.\u0275prov=s.\u0275\u0275defineInjectable({token:o,factory:o.\u0275fac,providedIn:"root"}),o})(),j=(()=>{class o{}return o.\u0275fac=function(e){return new(e||o)},o.\u0275dir=s.\u0275\u0275defineDirective({type:o,selectors:[["dtcde-dynamic"]]}),o})(),R=(()=>{class o extends M{constructor(e,t,n){super(),this.loader=e,this.injector=t,this.ref=n,this.fields=new Array,this.fieldsMap=new Map,this.parentForm=null,this.componentInited=new y.ReplaySubject}defineSubField(e,t){const n=new P(e,t);this.addSubField(n)}getSubField(e){const t=this.fieldsMap.get(e);if(null!=t)return this.fields[t]}addSubField(e){const t=this.fields.push(e);return this.fieldsMap.set(e.name,t-1),t}getSubFields(){return this.fields}setForm(e){if(this.name){const t=new C.FormGroup({},{updateOn:"blur"});e.registerControl(this.name,t),super.setForm(t),this.parentForm=e}else super.setForm(e),this.parentForm=null;this.preloadSubFields()}hydrateValueToForm(){if(null==this.parentForm)super.hydrateValueToForm();else{let e=this.transformToFormGroupValue(this.value);for(const t in this.form.controls)null==this.fieldsMap.get(t)&&this.form.get(t)?.setValue(e&&e[t],{emitEvent:!1})}}updateValueFromForm(){if(null==this.parentForm)return super.updateValueFromForm();{let e=!1;for(const t in this.form.controls)if(null==this.fieldsMap.get(t)){const n=this.form.get(t);if(null!=n&&n.dirty){const i=this.transformFromFormGroupValue(n?.value);null==this.value&&(this.value={}),this.value[t]=i,e=!0,n.markAsPristine({onlySelf:!0})}}return e}}setValue(e){super.setValue(e);for(const t of this.fields)this.setSubFieldValue(t,null!=e?e[t.name]:void 0)}getValue(){let e=super.getValue();for(const t of this.fields){const n=this.getSubFieldValue(t);null!=n&&null==e&&(this.value={},e=this.value),e[t.name]!==n&&(e[t.name]=n)}return e}subFieldFullEditTemplate(e){const t="string"==typeof e?this.getSubField(e):e,n=t?.component;let i=null;if(null!=n&&(i=n.providesTemplates(t?.type).forFullEdit),null==e)throw new Error("No template for subField "+t?.name+" of component "+this.name);return i}subFieldInlineViewTemplate(e){const t="string"==typeof e?this.getSubField(e):e,n=t?.component;let i=null;if(null!=n&&(i=n.providesTemplates(t?.type).forInlineView),null==e)throw new Error("No template for subField "+t?.name+" of component "+this.name);return i}subFieldFullViewTemplate(e){const t="string"==typeof e?this.getSubField(e):e,n=t?.component;let i=null;if(null!=n&&(i=n.providesTemplates(t?.type).forFullView),null==e)throw new Error("No template for subField "+t?.name+" of component "+this.name);return i}loadSubField(e,t,n){const i="string"==typeof e?this.getSubField(e):e,l=i?.component;return null==l?this.loader.insertComponentForFieldType(t,this.dynamicInsertPoint).then(a=>null!=a?(this.prepareComponent(a,t,null!=i?i.name:null,n),a):null):Promise.resolve(l)}getSubFieldValue(e){const t="string"==typeof e?this.getSubField(e):e,n=t?.component;if(null!=n)return n.getValue();if(null!=this.form&&null!=t)return this.form.get(t.name)?.value;throw new Error("Cannot provide value for non existent subField "+e)}setSubFieldValue(e,t){const n="string"==typeof e?this.getSubField(e):e,i=n?.component;if(null!=i)i.setValue(t);else if(null!=this.form&&null!=n){const l={};let a=o.toBeautifyString(t);null==a&&(a=null),l[n.name]=a,this.form.patchValue(l,{emitEvent:!1})}}loadSubComponent(e,t,n,i){return new Promise((l,a)=>this.componentInited.subscribe({complete:()=>{l()},error:u=>{a(u)}})).then(()=>(console.debug("LoadSubComponent:"+e.position+" with type "+t+", dynamicInsertPoint is ",null!=this.dynamicInsertPoint),null==this.dynamicInsertPoint?null:this.loader.insertComponent(e,this.dynamicInsertPoint,i).then(l=>null!=l?this.prepareComponent(l,t,n,i):null)))}prepareComponent(e,t,n,i){return n&&(null!=this.form&&(e.setName(n),e.setForm(this.form)),e.setValue(i)),e}applyComponentToSubField(e,t,n){let i=this.getSubField(n);return null==i?(i=new P(n,t,e),this.addSubField(i),!0):(i.component=e,!1)}ngAfterViewInit(){this.componentInited.complete(),this.preloadSubFields()}preloadSubFields(){if(null!=this.dynamicInsertPoint){let e=!1;for(const t of this.fields)null==t.component&&this.loadSubField(t.name,t.type,this.value?this.value[t.name]:void 0).then(i=>{null!=i&&this.applyComponentToSubField(i,t.type,t.name),null!=this.value&&!e&&(this.ref.detectChanges(),e=!0)})}}}return o.\u0275fac=function(e){return new(e||o)(s.\u0275\u0275directiveInject(S),s.\u0275\u0275directiveInject(s.Injector),s.\u0275\u0275directiveInject(s.ChangeDetectorRef))},o.\u0275cmp=s.\u0275\u0275defineComponent({type:o,selectors:[["ng-component"]],viewQuery:function(e,t){if(1&e&&s.\u0275\u0275viewQuery(j,5,s.ViewContainerRef),2&e){let n;s.\u0275\u0275queryRefresh(n=s.\u0275\u0275loadQuery())&&(t.dynamicInsertPoint=n.first)}},features:[s.\u0275\u0275InheritDefinitionFeature],decls:0,vars:0,template:function(e,t){},encapsulation:2}),o})();class P{constructor(r,e,t){this.name=r,this.type=e,this.component=t}}class D{constructor(){this.subscriptions=new y.Subscription,this.entityPointer=null,this.provider=null,this.mutex=new V}initCommandFlow(r,e,t){this.entityPointer=e,this.provider=r,this.changeHandler=t}decomposeJsonToMultipleChanges(r,e){if("object"==typeof e&&this.provider){let t;const n=this.provider.getSchemaManager();for(const i in e)if(e.hasOwnProperty(i)){const l=n.generateSubSchemaPointer(r,i),a=n.locateItem(l.positionInSchema);a?.isArray()&&l.isProperty?this.decomposeJsonToMultipleChanges(l,e[i]):(t=new c.Change(c.ChangeType.RESET,r.position+"/"+i,e[i],l),!a&&t.pointer&&(t.pointer.isProperty=!1),this.changeHandler&&this.changeHandler.handleChange(t))}}}initChangeListening(r){this.initOtherChangeListening(r,this.entityPointer)}initOtherChangeListening(r,e){if(!this.provider||!e)throw new Error("Cannot listen to change before initCommandFlow is called");{let t=e.position;!0!==r&&(t+="/?"),this.subscriptions.add(this.provider.receiveCommands(t).pipe((0,_.map)(n=>{this.changeHandler&&this.changeHandler.handleChange(n)})).subscribe())}}applyUpdatesToArray(r,e,t,n,i,l){return this.applyUpdatesToArrayAsync(r,e,t,n,(a,u)=>Promise.resolve(i(a,u)))}applyUpdatesToArrayAsync(r,e,t,n,i,l,a){return this.mutex.runExclusive(()=>{try{if(!this.provider)throw new Error("Cannot apply updates before initCommandFlow is called");t.pointer||(t.pointer=this.provider.calculatePointerFor(t.position)),l=l??this.entityPointer?.position,null!=n&&(l=l+"/"+n);const u=t.pointer.containerPosition===l;let p=u?t.pointer.lastElement:c.DontCodeModelPointer.lastElementOf(t.pointer.containerPosition)??null,d=t.pointer.isProperty?t.pointer.lastElement:null,h=null,b=null,m=-1,v=-1;switch(null!=p&&e.has(p)&&(m=e.get(p),b=r[m],h=(0,y.of)(b)),t.beforeKey&&(v=e.get(t.beforeKey)),t.type){case c.ChangeType.ADD:case c.ChangeType.UPDATE:case c.ChangeType.RESET:if(null!=d){if(!b||b&&(!a||!a(b,d,t.value))){const f=this.provider.getJsonAt(t.pointer.containerPosition),w=this.provider.calculatePointerFor(t.pointer.containerPosition);if(w.isProperty)throw new Error("A parent of a property "+t.pointer.position+" must be an array");h=(0,y.from)(i(w,f))}}else h=(0,y.from)(i(t.pointer,t.value));break;case c.ChangeType.MOVE:-1!==m&&u&&p&&(-1!==v&&v>m&&v--,r.splice(m,1),e.forEach((f,w)=>{f>m&&e.set(w,f-1)}),e.delete(p),m=-1);break;case c.ChangeType.DELETE:-1!==m&&u&&p&&(r.splice(m,1),e.forEach((f,w)=>{f>m&&e.set(w,f-1)}),e.delete(p)),h=null}return h?(0,y.firstValueFrom)(h.pipe((0,_.map)(f=>{if(-1!==m)r[m]=f;else if(-1!==v){if(r.splice(v,0,f),e.forEach((w,he)=>{w>=v&&e.set(he,w+1)}),null==p)throw new Error("Cannot set targetPos "+v+" without knowing the itemId");e.set(p,v)}else{if(r.push(f),null==p)throw new Error("Cannot set targetPos "+v+" without knowing the itemId");e.set(p,e.size)}return r}),(0,_.takeLast)(1),(0,_.catchError)(f=>Promise.reject(f)))):Promise.resolve(r)}catch(u){return Promise.reject(u)}})}unsubscribe(){this.subscriptions.unsubscribe()}}let L=(()=>{class o extends R{constructor(e,t,n){super(e,t,n),this.pluginHelper=new D,this.entityPointer=null,this.provider=null}ngOnDestroy(){this.pluginHelper.unsubscribe(),super.ngOnDestroy()}updateValueOnFormChanges(){this.subscriptions.add(this.form.valueChanges.pipe((0,_.map)(e=>(console.debug("Value changed",e),this.getValue(),e))).subscribe())}initCommandFlow(e,t){this.entityPointer=t,this.provider=e,this.pluginHelper.initCommandFlow(e,t,this)}initChangeListening(e){this.pluginHelper.initChangeListening(e)}decomposeJsonToMultipleChanges(e,t){this.pluginHelper.decomposeJsonToMultipleChanges(e,t)}decodeStringField(e,t){if(e.pointer?.lastElement===t)return e.value}applyUpdatesToArray(e,t,n,i,l,a,u){return this.applyUpdatesToArrayAsync(e,t,n,i,(p,d)=>Promise.resolve(l(p,d)),a)}applyUpdatesToArrayAsync(e,t,n,i,l,a,u){return this.pluginHelper.applyUpdatesToArrayAsync(e,t,n,i,l,a,u)}updateSubFieldsWithChange(e,t,n){return this.applyUpdatesToArrayAsync(this.fields,this.fieldsMap,e,t,(i,l)=>this.loadSubComponent(i,l.type,l.name).then(a=>new P(l.name,l.type,a??void 0)),n,(i,l,a)=>l===c.DontCodeModel.APP_FIELDS_NAME_NODE&&(i.name=a,!0)).then(i=>(this.fields=i,this.rebuildForm(),i))}rebuildForm(){if(null==this.form)return;const e=new Set;for(const t in this.form.controls)e.add(t);for(const t of this.fields){let n=null;this.value&&this.value[t.name]&&(n=this.value[t.name]),e.delete(t.name),null!=t.component?t.component?.setValue(n):(n=o.toBeautifyString(n),this.form.registerControl(t.name,new C.FormControl(n,C.Validators.required)))}e.forEach(t=>{this.form.removeControl(t)})}}return o.\u0275fac=function(e){return new(e||o)(s.\u0275\u0275directiveInject(S),s.\u0275\u0275directiveInject(s.Injector),s.\u0275\u0275directiveInject(s.ChangeDetectorRef))},o.\u0275cmp=s.\u0275\u0275defineComponent({type:o,selectors:[["ng-component"]],features:[s.\u0275\u0275InheritDefinitionFeature],decls:0,vars:0,template:function(e,t){},encapsulation:2}),o})(),k=(()=>{class o{transform(e,...t){return L.toBeautifyString(e,t[0])}}return o.\u0275fac=function(e){return new(e||o)},o.\u0275pipe=s.\u0275\u0275definePipe({name:"beautifier",type:o,pure:!0}),o})();class H{constructor(r,e,t){this.forInlineView=r,this.forFullView=e,this.forFullEdit=t}}class N{constructor(r,e,t){this.forInlineView=r,this.forFullView=e,this.forFullEdit=t}}class U{constructor(r,e,t){this.name=r,this.type=e,this.eventSource=t}}var E=(()=>{return(o=E||(E={})).VALUE_CHANGE="VALUE_CHANGE",o.SELECTION_CHANGE="SELECTION_CHANGE",E;var o})();class G{constructor(r,e,t){this.name=r,this.type=e,this.value=t}}let ae=(()=>{class o extends M{constructor(e,t){super(),this.modelMgr=e,this.storeMgr=t,this.valueChange=new s.EventEmitter,this.targetEntitiesPos=null,this.targetEntitiesProperty=null,this.options=new Array,null==e&&(this.modelMgr=c.dtcde.getModelManager()),null==t&&(this.storeMgr=c.dtcde.getStoreManager())}canProvide(e){return new N(!0,!1,!0)}providesTemplates(e){return new H(this.inlineView,null,this.fullEditView)}setTargetEntitiesWithName(e,t){const n=this.modelMgr.queryModelToSingle("$.creation.entities[?(@.name=='"+e+"')]");if(null==n)throw console.error("Cannot find an entity with name "+e+" in the model."),new Error("Cannot find an entity with name "+e+" in the model.");return this.targetEntitiesPos=n.pointer,null!=this.targetEntitiesPos&&(this.targetEntitiesProperty=t??null,this.subscriptions.add(this.possibleValues().subscribe({next:i=>{this.options=i},error:i=>{this.options=["Error",i.toString()]}})),!0)}possibleValues(){if(null==this.targetEntitiesPos)throw new Error("Missing query of target entity for class "+this.constructor.name);const e=this.storeMgr.searchEntities(this.targetEntitiesPos);if(null!=this.targetEntitiesProperty){const t=this.targetEntitiesProperty;return e.pipe((0,_.map)(n=>n.map(i=>i[t])))}return e}listEventSources(){const e=super.listEventSources();return e.push(new U("Value",E.VALUE_CHANGE,this.valueChange.asObservable())),e}valueChanged(e){this.valueChange.emit(new G("Value",E.VALUE_CHANGE,e.value))}setValue(e){null!=e&&null!=this.options&&-1==this.options.findIndex(t=>t==e)&&null!=this.options[1]&&(e=this.options[1].toString()),super.setValue(e)}}return o.\u0275fac=function(e){return new(e||o)(s.\u0275\u0275directiveInject(c.DontCodeModelManager,8),s.\u0275\u0275directiveInject(c.DontCodeStoreManager,8))},o.\u0275cmp=s.\u0275\u0275defineComponent({type:o,selectors:[["dontcode-reference"]],viewQuery:function(e,t){if(1&e&&(s.\u0275\u0275viewQuery(X,7),s.\u0275\u0275viewQuery(Z,7)),2&e){let n;s.\u0275\u0275queryRefresh(n=s.\u0275\u0275loadQuery())&&(t.inlineView=n.first),s.\u0275\u0275queryRefresh(n=s.\u0275\u0275loadQuery())&&(t.fullEditView=n.first)}},outputs:{valueChange:"valueChange"},features:[s.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["placeholder","Select a reference",3,"options","formControlName","filter","showClear","lazy","onChange"],["pTemplate","selectedItem"],["pTemplate","item"],[4,"ngIf"]],template:function(e,t){1&e&&(s.\u0275\u0275template(0,ee,1,1,"ng-template",null,0,s.\u0275\u0275templateRefExtractor),s.\u0275\u0275template(2,oe,1,1,"ng-template",null,1,s.\u0275\u0275templateRefExtractor))},dependencies:[x.NgIf,I.Dropdown,Y.PrimeTemplate,C.NgControlStatus,C.NgControlStatusGroup,C.FormGroupDirective,C.FormControlName],changeDetection:0}),o})();class ue{constructor(){this.subscriptions=new y.Subscription,this.pluginHelper=new D,this.entityPointer=null,this.provider=null}unsubscribe(){this.pluginHelper.unsubscribe(),this.subscriptions.unsubscribe()}initCommandFlow(r,e){this.entityPointer=e,this.provider=r,this.pluginHelper.initCommandFlow(r,e,this)}initChangeListening(){this.pluginHelper.initChangeListening()}decomposeJsonToMultipleChanges(r,e){this.pluginHelper.decomposeJsonToMultipleChanges(r,e)}applyUpdatesToArray(r,e,t,n,i,l){return this.applyUpdatesToArrayAsync(r,e,t,n,(a,u)=>Promise.resolve(i(a,u)))}applyUpdatesToArrayAsync(r,e,t,n,i,l,a){return this.pluginHelper.applyUpdatesToArrayAsync(r,e,t,n,i,l,a)}}let ce=(()=>{class o{constructor(e,t){this.storeMgr=e,this.modelMgr=t,this.listsByPosition=new Map}retrieveListManager(e,t){let n=this.listsByPosition.get(e.position);return null==n&&(n=new B(e,t,this.storeMgr,this.modelMgr),this.listsByPosition.set(e.position,n)),n}}return o.\u0275fac=function(e){return new(e||o)(s.\u0275\u0275inject(c.DontCodeStoreManager),s.\u0275\u0275inject(c.DontCodeModelManager))},o.\u0275prov=s.\u0275\u0275defineInjectable({token:o,factory:o.\u0275fac,providedIn:"root"}),o})();class B{constructor(r,e,t,n){this.storeMgr=t,this.modelMgr=n,this.entities=new Array,this.prepared=null,this.pointer=r,this.description=e}push(r){this.entities=[...this.entities,r]}updateWithDetailedEntity(r){const e=r._id,t=new Array;return this.entities.forEach(n=>{n._id==e?(r={...r,...n},t.push(r)):t.push(n)}),this.entities=[...t],r}replace(r){const e=r._id;let t=!1;const n=new Array;return this.entities.forEach(i=>{i._id==e?(n.push(r),t=!0):n.push(i)}),this.entities=[...n],t}remove(r){const e=r._id;return null==e?new Promise(t=>{this.entities=this.entities.filter(n=>n!==r),this.prepared=null,t(!0)}):this.storeMgr.deleteEntity(this.pointer.position,e).then(t=>(t&&(this.entities=this.entities.filter(n=>n!==r),this.prepared=null),t)).catch(t=>(console.error(t.message),!1))}reset(){this.entities.length=0,this.prepared=null}store(r){return this.prepared=null,this.storeMgr.storeEntity(this.pointer.position,r)}loadAll(){return(0,y.firstValueFrom)(this.storeMgr.searchEntities(this.pointer.position).pipe((0,_.map)(r=>{this.prepared=null,this.entities=[...r]})),{defaultValue:void 0})}searchAndPrepareEntities(r,e,t,...n){let i=null!=r?Object.values(r):[];const l=i.length>0?i[0]:void 0;i=null!=e?Object.values(e):[];const a=i.length>0?new c.DontCodeStoreGroupby(i[0].of,i[0].display):void 0;if(null!=this.entities){this.prepared=null;let p,u=this.entities;return null!=n&&(u=c.StoreProviderHelper.applyFilters(u,...n)),null!=l&&(u=c.StoreProviderHelper.multiSortArray(u,l)),null!=a&&(p=c.StoreProviderHelper.calculateGroupedByValues(u,a,this.modelMgr,this.pointer)),(null!=n||null!=r||null!=e)&&(this.prepared=new c.DontCodeStorePreparedEntities(u,l,p)),Promise.resolve()}return(0,y.firstValueFrom)(this.storeMgr.searchAndPrepareEntities(this.pointer.position,l,a,t,...n).pipe((0,_.map)(u=>{this.prepared=u,this.entities=this.prepared.sortedData})))}loadDetailFromKey(r){return null==r?Promise.reject("Cannot load entity with null key"):this.storeMgr.loadEntity(this.pointer.position,r).then(e=>null!=e?this.updateWithDetailedEntity(e):e)}loadDetailOf(r){return this.loadDetailFromKey(r._id)}}let pe=(()=>{class o{constructor(e){this.modelMgr=e}getContent(){return this.modelMgr.getContent()}resetContent(e){this.modelMgr.resetContent(e)}findAtPosition(e,t){return this.modelMgr.findAtPosition(e,t)}queryModelToArray(e,t){return this.modelMgr.queryModelToArray(e,t)}queryModelToSingle(e,t){return this.modelMgr.queryModelToSingle(e,t)}findAllPossibleTargetsOfProperty(e,t,n){return this.modelMgr.findAllPossibleTargetsOfProperty(e,t,n)}findTargetOfProperty(e,t,n){return this.modelMgr.findTargetOfProperty(e,t,n)}}return o.\u0275fac=function(e){return new(e||o)(s.\u0275\u0275inject(c.DontCodeModelManager))},o.\u0275prov=s.\u0275\u0275defineInjectable({token:o,factory:o.\u0275fac,providedIn:"root"}),o})(),de=(()=>{class o{static forRoot(){return{ngModule:o,providers:[{provide:F,useValue:c.dtcde},{provide:c.DontCodeSchemaManager,useValue:c.dtcde.getSchemaManager()},{provide:c.DontCodeModelManager,useValue:c.dtcde.getModelManager()},{provide:c.DontCodePreviewManager,useValue:c.dtcde.getPreviewManager()},{provide:c.DontCodeStoreManager,useValue:c.dtcde.getStoreManager()},{provide:c.DontCodeChangeManager,useValue:c.dtcde.getChangeManager()},k]}}}return o.\u0275fac=function(e){return new(e||o)},o.\u0275mod=s.\u0275\u0275defineNgModule({type:o}),o.\u0275inj=s.\u0275\u0275defineInjector({imports:[x.CommonModule,I.DropdownModule,C.ReactiveFormsModule]}),o})()}}]);